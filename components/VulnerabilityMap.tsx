import React from 'react';
import { 
  ShieldAlert, 
  AlertTriangle, 
  ZoomIn, 
  Layers, 
  Activity,
  Info
} from 'lucide-react';
import { 
  Radar, 
  RadarChart, 
  PolarGrid, 
  PolarAngleAxis, 
  PolarRadiusAxis, 
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  Cell
} from 'recharts';
import { AnalysisResult, BuildingParams } from '../types';

interface VulnerabilityMapProps {
  analysis: AnalysisResult | null;
  buildingParams: BuildingParams;
}

const VulnerabilityMap: React.FC<VulnerabilityMapProps> = ({ analysis, buildingParams }) => {

  // Mock data generation if analysis exists, otherwise empty
  const radarData = analysis ? [
    { subject: 'Shear Capacity', A: 120 - analysis.vulnerabilityScore, fullMark: 100 },
    { subject: 'Flexural Strength', A: 90, fullMark: 100 },
    { subject: 'Ductility', A: Math.max(20, 100 - analysis.vulnerabilityScore * 1.2), fullMark: 100 },
    { subject: 'Drift Limit', A: 70, fullMark: 100 },
    { subject: 'Liquefaction', A: (buildingParams.seismicZone === 'Zone IV' || buildingParams.seismicZone === 'Zone V') ? 40 : 90, fullMark: 100 },
    { subject: 'Foundation', A: 85, fullMark: 100 },
  ] : [];

  const zoneData = analysis ? [
    { name: 'Ground Floor', risk: analysis.vulnerabilityScore + 10 },
    { name: 'Floor 2', risk: analysis.vulnerabilityScore - 10 },
    { name: 'Floor 3', risk: analysis.vulnerabilityScore - 20 },
    { name: 'Roof', risk: Math.max(10, analysis.vulnerabilityScore - 40) },
  ] : [];

  if (!analysis) {
    return (
      <div className="flex flex-col items-center justify-center h-full text-slate-400 p-8 text-center">
        <ShieldAlert className="w-16 h-16 mb-4 text-slate-600" />
        <h2 className="text-xl font-bold text-white mb-2">Analysis Required</h2>
        <p className="max-w-md">Run the Structural Diagnostic from the Dashboard to generate the vulnerability map and failure mode analysis.</p>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full gap-6 p-6 overflow-y-auto">
      <div className="flex justify-between items-end">
        <div>
          <h1 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
            <ShieldAlert className="text-red-500" /> Vulnerability Map
          </h1>
          <p className="text-slate-400 text-sm">Detailed breakdown of structural weaknesses and failure probabilities.</p>
        </div>
        <div className="text-right">
          <p className="text-xs text-slate-500 font-mono uppercase mb-1">Total Risk Index</p>
          <div className="text-3xl font-bold text-white flex items-center justify-end gap-2">
            <span className={analysis.vulnerabilityScore > 50 ? 'text-red-500' : 'text-green-500'}>
              {analysis.vulnerabilityScore}
            </span>
            <span className="text-lg text-slate-600">/ 100</span>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {/* Failure Mode Radar */}
        <div className="bg-slate-800 rounded-xl border border-slate-700 shadow-lg p-6">
          <h3 className="text-sm font-semibold text-white mb-4 flex items-center gap-2">
            <Activity className="w-4 h-4 text-cyan-400" /> Structural Performance Metrics
          </h3>
          <div className="h-64 w-full">
            <ResponsiveContainer width="100%" height="100%">
              <RadarChart cx="50%" cy="50%" outerRadius="80%" data={radarData}>
                <PolarGrid stroke="#334155" />
                <PolarAngleAxis dataKey="subject" tick={{ fill: '#94a3b8', fontSize: 10 }} />
                <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                <Radar
                  name="Building Capacity"
                  dataKey="A"
                  stroke="#06b6d4"
                  strokeWidth={2}
                  fill="#06b6d4"
                  fillOpacity={0.3}
                />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1e293b', borderColor: '#475569', color: '#f8fafc' }}
                  itemStyle={{ color: '#f8fafc' }}
                />
              </RadarChart>
            </ResponsiveContainer>
          </div>
          <p className="text-xs text-center text-slate-500 mt-2">
            Higher values indicate better performance (Capacity > Demand)
          </p>
        </div>

        {/* Zone Analysis Bar Chart */}
        <div className="bg-slate-800 rounded-xl border border-slate-700 shadow-lg p-6">
          <h3 className="text-sm font-semibold text-white mb-4 flex items-center gap-2">
            <Layers className="w-4 h-4 text-orange-400" /> Vertical Stress Distribution
          </h3>
          <div className="h-64 w-full">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={zoneData} layout="vertical">
                <XAxis type="number" hide domain={[0, 100]} />
                <YAxis dataKey="name" type="category" width={80} tick={{ fill: '#94a3b8', fontSize: 11 }} />
                <Tooltip 
                  cursor={{fill: 'transparent'}}
                  contentStyle={{ backgroundColor: '#1e293b', borderColor: '#475569', color: '#f8fafc' }}
                />
                <Bar dataKey="risk" barSize={20} radius={[0, 4, 4, 0]}>
                  {zoneData?.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.risk > 60 ? '#ef4444' : entry.risk > 30 ? '#f97316' : '#22c55e'} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
          <p className="text-xs text-slate-400 mt-2">
            Displays calculated stress accumulation per floor level relative to code limits.
          </p>
        </div>
      </div>

      {/* Critical Zones List */}
      <div className="bg-slate-800 rounded-xl border border-slate-700 shadow-lg p-6">
        <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
           <AlertTriangle className="text-yellow-500" /> Identified Weak Points
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {analysis.criticalZones && analysis.criticalZones.length > 0 ? (
            analysis.criticalZones?.map((zone, idx) => (
            <div key={idx} className="bg-red-900/10 border border-red-900/30 p-4 rounded-lg flex items-start gap-3">
               <div className="mt-1 w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
               <div>
                 <h4 className="text-red-200 font-medium text-sm">{zone}</h4>
                 <p className="text-slate-400 text-xs mt-1">
                   High probability of non-ductile failure under lateral load.
                 </p>
               </div>
            </div>
          ))) : (
             <p className="text-sm text-slate-500 italic">No specific critical zones identified.</p>
          )}
          
          {/* Mock extra data for visuals if list is short and analysis exists */}
          {analysis.criticalZones && analysis.criticalZones.length < 3 && (
            <div className="bg-orange-900/10 border border-orange-900/30 p-4 rounded-lg flex items-start gap-3">
               <div className="mt-1 w-2 h-2 rounded-full bg-orange-500"></div>
               <div>
                 <h4 className="text-orange-200 font-medium text-sm">Foundation Anchorage</h4>
                 <p className="text-slate-400 text-xs mt-1">
                   Potential for uplift; inspection recommended.
                 </p>
               </div>
            </div>
          )}
        </div>
      </div>
      
      {/* Methodology Note */}
      <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-800 flex gap-3">
         <Info className="w-5 h-5 text-slate-500 flex-shrink-0" />
         <p className="text-xs text-slate-500 leading-relaxed">
           Analysis based on ASCE 41-17 tier 1 evaluation standards and predictive AI modeling. 
           Failure probabilities are estimates assuming Peak Ground Acceleration (PGA) consistent with the selected seismic zone.
           Always verify with physical core sampling.
         </p>
      </div>

    </div>
  );
};

export default VulnerabilityMap;